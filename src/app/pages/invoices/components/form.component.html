<div class="container-fluid page-body-wrapper">
  <div class="main-panel">
    <div class="jumbotron jumbotron-fluid">
      <div class="container">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a routerLink="/">Trang chủ</a></li>
            <li class="breadcrumb-item"><a routerLink="/invoices">Danh sách hóa đơn</a></li>
            <li *ngIf="invoiceId" class="breadcrumb-item active" aria-current="page">Mở hóa đơn</li>
            <li *ngIf="!invoiceId" class="breadcrumb-item active" aria-current="page">Lập hóa đơn</li>
          </ol>
        </nav>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="row">
        <div class="container-fluid">
          <div class="template-ein navbar-action">
            <button type="button" [disabled]="disabledAdd" (click)="addNewButtonClicked()" class="btn btn-md btn-primary">
              <i class="fas fa-plus"></i> Thêm
            </button>
            <button type="button" (click)="editClicked()" [disabled]="disabledEdit" class="btn btn-md btn-outline-primary"><i
                class="fas fa-edit"></i>
              Sửa</button>
            <button type="button" (click)="adjustClicked()" [disabled]="disabledAdjust" class="btn btn-md btn-outline-primary"><i
                class="fas fa-edit"></i>
              Điều chỉnh</button>
            <button type="button" (click)="isPreview=false; ngAddForm.ngSubmit.emit()" class="btn btn-md btn-success">
              <i class="fas fa-save"></i> Lưu
            </button>
            <button type="button" [disabled]="previewLoading" (click)="isPreview=true; ngAddForm.ngSubmit.emit()" class="btn btn-md btn-outline-primary">
              <i *ngIf="previewLoading" class="fa fa-spinner fa-spin"></i>
              <i *ngIf="!previewLoading" class="fas fa-info"></i>
              Xem
            </button>

            <button id="signButton" [disabled]="disabledSign" type="button" (click)="openModalMd(listToken)" class="btn btn-md btn-outline-primary">
              <i class="fas fa-key"></i> Ký
            </button>
            <ng-template #listToken>
              <div class="modal-header">
                <h4 class="modal-title pull-left">Xác nhận token</h4>
                <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div *ngIf="signErrorMessage" class="alert alert-danger" role="alert">
                  {{signErrorMessage}}
                </div>

                <ngx-select-dropdown (open)="loadTokenData()" [multiple]="false" (valueChange)="onTokenChange($event)"
                  [config]="configSingleBox" [options]="listTokenAvaiable">
                </ngx-select-dropdown>
                <div class="btn-group">
                  <button type="button" [disabled]="signButtonDisabled" class="btn btn-primary mr-1 no-br" (click)="tokenChoiceClicked()">
                    <i *ngIf="signButtonLoading" class="fa fa-spinner fa-spin"></i>
                    <i *ngIf="!signButtonLoading" class="fas fa-key"></i>
                    {{ signButtonLoading ? 'Vui lòng chờ...' : 'Đồng ý' }}
                  </button>
                  <button type="button" class="btn btn-default" (click)="modalRef.hide()">Bỏ qua</button>
                </div>
              </div>
            </ng-template>

            <button [disabled]="disabledInCD" (click)="inCDClicked()" type="button" class="btn btn-md btn-outline-primary"><i
                class="fas fa-print"></i>
              In CĐ</button>
            <button routerLink="/invoices" type="button" class="btn btn-md btn-light">
              <i class="fas fa-share-square"></i> Thoát
            </button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="card card-shadow px-2">
            <div class="card-body invoice__wrapper">
              <div *ngIf="adjust" class="alert alert-danger">
                Đang viết hóa đơn điều chỉnh cho hóa đơn số:
                <a routerLink="/invoices/update/{{invoiceId}}"><strong>#{{this.invoiceId}}, mẫu: {{form}}, ký hiệu:
                    {{serial}} </strong></a>
                <a (click)="backClicked()" class="btn btn-md btn-light">Quay lại</a>
              </div>

              <form class="invoice__form" #ngAddForm="ngForm" [formGroup]="addForm" (ngSubmit)="onSubmit(addForm.value)">
                <div class="invoice__body">
                  <div class="row">
                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label">
                          <label class="text-bold required">Ngày lập</label>
                        </div>
                        <div class="col-md-8 col-lg-8">
                          <div class="input-group">
                            <input [readonly]="viewMode" formControlName="invoiceDate" class="form-control form-control-sm text-bold"
                              [ngClass]="{ 'is-invalid': submitted && addForm.controls['invoiceDate'].errors }"
                              placeholder="DD/MM/YYYY" triggers="none" [bsConfig]="bsConfig" #dinvoiceDate="bsDatepicker"
                              bsDatepicker />
                            <div *ngIf="!viewMode" class="input-group-append">
                              <button class="btn btn-icons btn-inverse-light btn-md" (click)="dinvoiceDate.toggle()"
                                [attr.aria-expanded]="dinvoiceDate.isOpen" type="button">
                                <i class="fas fa-calendar"></i>
                              </button>
                            </div>
                          </div>
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['invoiceDate']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label>Số hóa đơn</label></div>
                        <div class="col-md-8 col-lg-8">
                          <input formControlName="invoiceNo" readonly="readonly" type="text" class="form-control form-control-sm" />
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label class="required">Mẫu số</label></div>
                        <div class="col-md-8 col-lg-8">
                          <!-- <div class="input-group input-group-sm c-group">
                            <div class="input-group-prepend" [ngClass]="{ 'is-viewable': viewMode }">
                              <input formControlName="form" readonly="readonly" type="text" class="form-control form-control-sm form-control-custom" />
                            </div>
                            <ngx-select-dropdown *ngIf="!viewMode" [multiple]="false" (open)="loadFormBox()"
                              (valueChange)="onFormChange($event)" [config]="configSingleBox" (value)="formPicked"
                              [options]="comboForm">
                            </ngx-select-dropdown>
                          </div> -->
                          <ng-select formControlName="form"
                            [items]="comboForm" [clearable]="false" [searchable]="false" bindLabel="code" bindValue="value">
                          </ng-select>
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['form']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label class="required">Ký hiệu</label></div>
                        <div class="col-md-8 col-lg-8">
                          <!-- <div class="input-group input-group-sm c-group">
                            <div class="input-group-prepend" [ngClass]="{ 'is-viewable': viewMode }">
                              <input formControlName="serial" readonly="readonly" type="text" class="form-control form-control-sm form-control-custom" />
                            </div>
                            <ngx-select-dropdown *ngIf="!viewMode" (value)="serialPicked" [multiple]="false"
                              (valueChange)="onSerialChange($event)" [config]="configSingleBox" [options]="comboSerial">
                            </ngx-select-dropdown>
                          </div> -->
                          <ng-select formControlName="serial"
                            [items]="comboSerial" [clearable]="false" [searchable]="false" bindLabel="code" bindValue="value">
                          </ng-select>
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['serial']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label class="required">Mã KH</label></div>
                        <div class="col-md-8 col-lg-8">
                          <div class="input-group input-group-sm c-group">
                            <div class="input-group-prepend" [ngClass]="{ 'is-viewable': viewMode }">
                              <input formControlName="customerCode" readonly="readonly" type="text" class="form-control form-control-sm form-control-custom" />
                            </div>
                            <ngx-select-dropdown *ngIf="!viewMode" [multiple]="false" (open)="loadCustomers()"
                              [(value)]="customerPicked" (valueChange)="onCustomerCodeChange($event)" [config]="configCode"
                              [options]="customerArr"></ngx-select-dropdown>
                          </div>
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['customerCode']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label required"><label>Mã số thuế</label></div>
                        <div class="col-md-8 col-lg-8">
                          <div class="input-group input-group-sm c-group">
                            <div class="input-group-prepend" [ngClass]="{ 'is-viewable': viewMode }">
                              <input formControlName="customerTax" readonly="readonly" type="text" class="form-control form-control-sm form-control-custom" />
                            </div>
                            <ngx-select-dropdown *ngIf="!viewMode" [multiple]="false" [(value)]="customerPicked"
                              (valueChange)="onCustomerTaxChange($event)" [config]="configTaxCode" [options]="customerArr"></ngx-select-dropdown>
                          </div>
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['customerTax']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label>Email</label></div>
                        <div class="col-md-8 col-lg-8">
                          <input formControlName="customerEmail" [readonly]="viewMode" type="text" class="form-control form-control-sm"
                            [ngClass]="{ 'is-invalid': submitted && addForm.controls['customerEmail'].errors }" />
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['customerEmail']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label>Mã ĐH</label></div>
                        <div class="col-md-8 col-lg-8">
                          <input type="text" [readonly]="viewMode" formControlName="orderNo" placeholder="Mã đơn hàng"
                            class="form-control form-control-sm" />
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6 col-lg-6">
                      <div class="form-group row">
                        <div class="col-md-2 col-lg-2 col-form-label required"><label>Tên đơn vị</label></div>
                        <div class="col-md-10 col-lg-10">
                          <input formControlName="customerOrg" [readonly]="viewMode" placeholder="(Tên đơn vị)" class="form-control form-control-sm"
                            name="customerOrg" type="text" [ngClass]="{ 'is-invalid': submitted && addForm.controls['customerOrg'].errors }" />
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['customerOrg']"></app-control-message>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 col-lg-6">
                      <div class="form-group row">
                        <div class="col-md-2 col-lg-2 col-form-label required"><label>Người mua</label></div>
                        <div class="col-md-10 col-lg-10">
                          <input type="text" formControlName="customerName" [readonly]="viewMode" class="form-control form-control-sm"
                            [ngClass]="{ 'is-invalid': submitted && addForm.controls['customerName'].errors }" />
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['customerName']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-12 col-lg-12">
                      <div class="form-group row">
                        <div class="col-md-1 col-lg-1 col-form-label"><label>Địa chỉ</label></div>
                        <div class="col-md-11 col-lg-11">
                          <input formControlName="customerAddress" [readonly]="viewMode" type="text" placeholder="Địa chỉ"
                            class="form-control form-control-sm" [ngClass]="{ 'is-invalid': submitted && addForm.controls['customerAddress'].errors }" />
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['customerAddress']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label class="required">HTTT</label></div>
                        <div class="col-md-8 col-lg-8">
                          <!-- <div class="input-group input-group-sm c-group">
                            <div class="input-group-prepend" [ngClass]="{ 'is-viewable': viewMode }">
                              <input formControlName="paymentType" readonly="readonly" type="text" class="form-control form-control-sm form-control-custom" />
                            </div>
                            <ngx-select-dropdown *ngIf="!viewMode" [(value)]="htttPicked" [multiple]="false"
                              (valueChange)="onHtttChange($event)" [config]="configSingleBox" [options]="comboHTTT">
                            </ngx-select-dropdown>
                          </div> -->
                          <ng-select formControlName="paymentType" [(ngModel)]="htttPicked"
                            [items]="comboHTTT" [clearable]="false" [searchable]="false" bindLabel="code" bindValue="value">
                          </ng-select>
                          <app-control-message *ngIf="submitted" [control]="addForm.controls['paymentType']"></app-control-message>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label>Số TK</label></div>
                        <div class="col-md-8 col-lg-8">
                          <input formControlName="customerBankAccount" [readonly]="viewMode" type="text" placeholder="Số tài khoản"
                            class="form-control form-control-sm" />
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label>Ngân hàng</label></div>
                        <div class="col-md-8 col-lg-8">
                          <input formControlName="customerBank" [readonly]="viewMode" type="text" placeholder="Ngân hàng"
                            class="form-control form-control-sm" />
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3 col-lg-3">
                      <div class="form-group row">
                        <div class="col-md-4 col-lg-4 col-form-label"><label>Trạng thái</label></div>
                        <div class="col-md-8 col-lg-8">
                          <input type="text" formControlName="status" readonly="readonly" class="form-control form-control-sm" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="product-item__wrapper">
                    <h3 class="sub-title">
                      <small class="sub-title__small">Chi tiết hóa đơn</small>
                      <button (click)="hiddenColumnClicked()" type="button" class="btn btn-light btn-md">Ẩn/Hiện cột</button>
                    </h3>
                    <p *ngIf="noItemLine" class="error text-danger">Không có thông tin sản phẩm</p>
                    <table class="table table-bordered no-border-right">
                      <thead>
                        <tr>
                          <th class="bg-smoke" style="width: 20px;">#</th>
                          <th style="width: 120px;">Mã HH</th>
                          <th style="width: 500px;">Nội dung</th>
                          <th style="width: 100px;">ĐV</th>
                          <th style="width: 100px;" class="text-right">Số lượng</th>
                          <th style="width: 140px;" class="text-right">Đơn giá</th>
                          <th style="width: 140px;" class="text-right">Tiền chưa thuế</th>
                          <th *ngIf="!hiddenExColumn" style="width: 80px;" class="text-right">% CK</th>
                          <th *ngIf="!hiddenExColumn" style="width: 140px;" class="text-right">Tiền CK</th>
                          <th style="width: 60px;" class="text-right">% Thuế</th>
                          <th style="width: 140px;" class="text-right">Tiền thuế</th>
                          <th style="width: 140px;" class="text-right">Thành tiền</th>

                        </tr>
                      </thead>
                      <tbody formArrayName="items">
                        <tr class="product-line" *ngFor="let item of itemFormArray.controls; let idx = index"
                          [formGroupName]="idx">
                          <td class="no-padding bg-smoke text-center">
                            {{idx + 1}}
                          </td>

                          <td class="no-padding invoice-no__item">
                            <div class="input-group input-group-sm c-group">
                              <div class="input-group-prepend" [ngClass]="{ 'is-viewable': viewMode }">
                                <input formControlName="item_code" readonly="readonly" type="text" class="form-control form-control-sm form-control-custom" />
                              </div>
                              <ngx-select-dropdown *ngIf="!viewMode" (valueChange)="onGoodlineChange($event, idx)"
                                [multiple]="false" [config]="configGood" [options]="goodArr"></ngx-select-dropdown>
                            </div>
                          </td>

                          <td class="no-padding">
                            <input formControlName="item_name" [readonly]="viewMode" class="form-control form-control-sm"
                              name="item_item_name" type="text" />
                          </td>

                          <td class="no-padding">
                            <input formControlName="unit" [readonly]="viewMode" class="form-control form-control-sm"
                              name="item_unit" type="text" />
                          </td>

                          <td class="no-padding">
                            <input formControlName="quantity" mask="000000" (input)="quantityValueChange($event.target.value, idx)"
                              class="form-control form-control-sm text-right" type="text" />
                          </td>

                          <td class="no-padding">
                            <input formControlName="price" [readonly]="viewMode" mask="000,000,000" (input)="priceValueChange($event.target.value, idx)"
                              class="form-control form-control-sm text-right" type="text" />
                          </td>

                          <td class="no-padding text-right is-viewable">
                            <label class="mt-2 mr-2">{{totalAmount[idx] | number:'.0-2'}}</label>
                          </td>

                          <td [(hidden)]="hiddenExColumn" class="no-padding">
                            <input formControlName="discount_rate" [readonly]="viewMode" mask="00" (input)="discountRateValueChange($event.target.value, idx)"
                              class="form-control form-control-sm text-right" type="text" />
                          </td>

                          <td [(hidden)]="hiddenExColumn" class="no-padding">
                            <input formControlName="discount" [readonly]="viewMode" mask="000,000,000" (input)="discountValueChange($event.target.value, idx)"
                              class="form-control form-control-sm text-right" type="text" />
                          </td>

                          <td class="no-padding vat-line">
                            <ng-select formControlName="tax_rate" (change)="taxRateValueChange($event, idx)"
                              [(ngModel)]="taxRatePicked" [items]="comboTaxRate" [clearable]="false" [searchable]="false" bindLabel="code" bindValue="value">
                            </ng-select>
                          </td>

                          <td class="no-padding text-right is-viewable">
                            <label class="mt-2 mr-2">{{totalPriceTax[idx] | number:'.0-2'}}</label>
                          </td>

                          <td class="no-padding text-right is-viewable">
                            <label class="mt-2 mr-2">{{totalAmoutWt[idx] | number:'.0-2'}}</label>
                          </td>

                          <div *ngIf="!viewMode" class="sticky-btn__td">
                            <a (click)="deleteLineClicked(idx)" title="Xóa dòng" class="sticky_btn">
                              <i class="fas fa-times"></i>
                            </a>
                          </div>
                        </tr>

                      </tbody>
                      <tfoot>
                        <tr class="tb-footer" [ngClass]="{ 'is-viewable': viewMode }">
                          <th class="td-expand-line" colspan="2">
                            <button *ngIf="!viewMode" type="button" (click)="addMoreLineClicked()" class="btn btn-light btn-md">
                              <i class="fas fa-plus"></i>Thêm dòng
                            </button>
                          </th>
                          <th></th>
                          <th></th>
                          <th></th>
                          <th></th>
                          <th class="text-right">
                            {{ sumTotalAmount() | currency:'VND':'symbol':'4.0-2'}}
                          </th>
                          <th *ngIf="!hiddenExColumn" class="text-right"></th>
                          <th *ngIf="!hiddenExColumn" class="text-right"></th>
                          <th></th>
                          <th class="text-right">
                            {{ sumTotalPriceTax() | currency:'VND':'symbol':'4.0-2'}}
                          </th>
                          <th class="text-right">
                            {{ sumTotalAmountWt() | currency:'VND':'symbol':'4.0-2'}}
                          </th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>